"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("cc");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=t(require("moment"));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function n(e,t,s,n){var r,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(i<3?r(o):i>3?r(t,s,o):r(t,s))||o);return i>3&&o&&Object.defineProperty(t,s,o),o}function r(e,t,...s){if("function"==typeof e)return Reflect.apply(e,t,s);if("object"==typeof e){let n=Reflect.get(e,t,s);if(void 0===n)return;return r(n,e,...s)}return null}function i(e,t,s){let n=0,r=()=>{++n>=e.length&&s()};for(let s of e)t(s,r)}class o{static Register(e){e.info&&(this.info=e.info),e.warn&&(this.warn=e.warn),e.error&&(this.error=e.error)}static Log(e,...t){o.doLogger(this.info,e,...t)}static Warn(e,...t){o.doLogger(this.warn,e,...t)}static Error(e,...t){o.doLogger(this.error,e,...t)}static doLogger(e,t,...n){let r=s.default().format("YYYY-MM-DD HH:mm:ss.SSS")+": ";"string"==typeof t?e(r+t,...n):e(r,t)}}o.info=console.log,o.warn=console.warn,o.error=console.error;const a=Symbol(),l=e=>new Proxy(e,{construct:(e,t,s)=>e.prototype!==s.prototype?Reflect.construct(e,t,s):(e[a]||(e[a]=Reflect.construct(e,t,s)),e[a])});function c(e){return null!=e}class h{static IsSceneScriptRegistered(e){return this.sceneScriptClasses.has(e)}static GetSceneScriptConstrutor(e){var t;return this.IsSceneScriptRegistered(e)&&null!==(t=this.sceneScriptClasses.get(e))&&void 0!==t?t:null}static IsUIScriptRegistered(e){if("string"==typeof e)return this.uiScriptClasses.has(e);let t=e.prototype.constructor.name;return!!this.uiClassNamesMap.has(t)&&this.uiScriptClasses.has(this.uiClassNamesMap.get(t))}static GetUIScriptConstructor(e){var t;return null!==(t=this.uiScriptClasses.get(e))&&void 0!==t?t:null}static GetUIClassRegisteredName(e){var t;return null!==(t=this.uiClassNamesMap.get(e.prototype.constructor.name))&&void 0!==t?t:null}}h.sceneScriptClasses=new Map,h.uiClassNamesMap=new Map,h.uiScriptClasses=new Map;class u extends e.Component{Get(t,s){if(void 0===s)return e.find(t,this.node);var n=e.find(t,this.node);return null===n?null:n.getComponent(s)}}function p(t){let s=e.Asset;switch(t){case"Prefab":s=e.Prefab;break;case"SpriteFrame":s=e.SpriteFrame;break;case"Texture2D":s=e.Texture2D;break;case"Material":s=e.Material}return s}let d=class{constructor(){this.config={},this.pathsGroupByScene=new Map,this.assetsGroupByUrl=new Map}Load(t){return new Promise(((s,n)=>{if(c(t))return this.build(t),void s(this.config);e.resources.load("configs/res",e.JsonAsset,((e,t)=>{void 0===e?(this.build(t),s(this.config)):n(e)}))}))}build(e){let t=e.json;this.config=t,this.buildPathesGroupByScene()}IsAutoRelease(e){var t;return null!==(t=this.config[e].autoRelease)&&void 0!==t&&t}SyncUrlAsset(e,t){this.assetsGroupByUrl.has(e)||this.assetsGroupByUrl.set(e,new Set),this.assetsGroupByUrl.get(e).add(t)}GetAssetNamesByUrl(e){return this.assetsGroupByUrl.has(e)?Array.from(this.assetsGroupByUrl.get(e)):[]}GetSceneInfo(e){return this.config[e]}getBundles(e){let t=this.config[e];return void 0===t?[]:Array.from(new Set(t.assets.map((e=>this.buildAssetDirInfo(e).bundleName))))}getScenesBundles(e){return Array.from(new Set(e.reduce(((e,t)=>e.concat(this.getBundles(t))),this.getBundles("Persistence"))))}getSceneDirs(e){let t=this.config[e];return void 0===t?[]:t.assets.map((e=>this.buildAssetDirInfo(e)))}getBundleDirs(e,t){return void 0===this.config[e]?[]:this.getSceneDirs(e).filter((e=>e.bundleName===t))}getScenesBundleDirs(e,t){return e.reduce(((e,s)=>e.concat(this.getBundleDirs(s,t))),this.getBundleDirs("Persistence",t))}buildAssetDirInfo(e){let t=e.url,s=/.*\:\/\//.exec(t);if(null===s)return null;let n=s[0].slice(0,-3);if(s=/\:\/\/.*/.exec(t),null===s)return null;let r=s[0].slice(3);return{sceneName:this.GetSceneNameByUrl(t),url:t,bundleName:n,path:r,type:p(e.type)}}GetSceneNameByUrl(e){var t;return null!==(t=this.pathsGroupByScene.get(e))&&void 0!==t?t:"Persistence"}buildPathesGroupByScene(){this.pathsGroupByScene.clear(),Object.keys(this.config).forEach((e=>{this.config[e].assets.forEach((t=>{this.pathsGroupByScene.set(t.url,e)}))}))}};var g,f;d=n([l],d),exports.ResourceManager=g=class{constructor(){this.assets_gby_Bundle=new Map,this.assets_gby_Scene=new Map,this.bundles=new Map,this.config=new d,this.sceneName="",Reflect.set(g,"Instance",this)}initialize(e){return new Promise(((t,s)=>{this.config.Load(e).then((e=>{t(void 0)})).catch()}))}loadScene(t,s,n){if("SceneEntry"===t)return s(1,1,void 0),void n(null,void 0);let r=this.config.GetSceneInfo(t),i=r.bundle;c(r.bundle)?this.pullBundle(i).then((r=>{r.loadScene(t,((e,t,n)=>{s(e,t,n)}),((s,r)=>{e.director.loadScene(t,n)}))})):e.director.preloadScene(t,((e,t,n)=>{s(e,t,n)}),((s,r)=>{e.director.loadScene(t,n)}))}LoadSceneRes(e){return new Promise(((t,s)=>{this.unloadSceneRes(this.curSceneName),this.loadNewSceneRes(e).then((()=>{t(void 0)})).catch(s)}))}unloadSceneRes(e){if(console.log("unload scene %s",e),!this.config.IsAutoRelease(e))return;let t=this.config.getSceneDirs(e);t.forEach((e=>{var t;null===(t=this.bundles.get(e.bundleName))||void 0===t||t.release(e.path,e.type)}));let s=t.map((e=>e.url)).reduce(((e,t)=>this.config.GetAssetNamesByUrl(t)),new Array),n=this.config.getBundles(e);Array.from(this.assets_gby_Bundle.keys()).filter((e=>n.includes(e))).forEach((e=>{Array.from(this.assets_gby_Bundle.get(e).keys()).filter((e=>s.includes(e))).forEach((t=>{this.assets_gby_Bundle.get(e).delete(t),console.log("移除%s包 %s资源",e,t)}))})),this.assets_gby_Scene.has(e)&&Array.from(this.assets_gby_Scene.get(e).keys()).forEach((t=>{s.includes(t)&&(this.assets_gby_Scene.get(e).delete(t),console.log("移除%s场景 %s资源",e,t))}))}loadNewSceneRes(e){return new Promise(((t,s)=>{console.log("加载自定义场景资源: ",e[0]);let n=this.config.getScenesBundles(e);console.log("包列表",n),i(n,((t,n)=>{let r=t;this.pullBundle(r).then((t=>{i(this.config.getScenesBundleDirs(e,r),((e,t)=>{this.loadResourceDir(e).then((s=>{var n,i;let a=e.url,l=e.sceneName;this.assets_gby_Bundle.has(r)||this.assets_gby_Bundle.set(r,new Map),this.assets_gby_Scene.has(l)||this.assets_gby_Scene.set(l,new Map);for(let e of s.keys())o.Log("%s load asset %s",r,e),o.Log("%s load asset %s",l,e),null===(n=this.assets_gby_Bundle.get(r))||void 0===n||n.set(e,s.get(e)),null===(i=this.assets_gby_Scene.get(l))||void 0===i||i.set(e,s.get(e)),this.config.SyncUrlAsset(a,e);t()}))}),(()=>{n()}))})).catch((e=>{s(e),n()}))}),(()=>{console.log("finished"),t(void 0)}))}))}get curSceneName(){return this.sceneName}Get(e,t){console.log(this.assets_gby_Scene);let s=this.GetPersist(e);return c(s)||(s=this.GetScene(e,null!=t?t:this.curSceneName)),s}GetPersist(e){var t;return null===(t=this.assets_gby_Scene.get("Persistence"))||void 0===t?void 0:t.get(e)}GetScene(e,t){var s;return null===(s=this.assets_gby_Scene.get(t))||void 0===s?void 0:s.get(e)}pullBundle(t){return new Promise(((s,n)=>{if(!this.bundles.has(t))return"resources"===t?(this.bundles.set("resources",e.resources),void s(e.resources)):void e.assetManager.loadBundle(t,((e,r)=>{c(e)&&n("load bundle error"),c(r)||n("load bundle error"),this.bundles.set(t,r),s(r)}));s(this.bundles.get(t))}))}preloadDir(e,t,s){e.getDirWithPath(t,s).forEach((e=>{console.log(e.path)}))}loadResourceDir(e){return new Promise(((t,s)=>{let n=e.bundleName,r=e.path;this.pullBundle(n).then((n=>{n.loadDir(r,e.type,((e,r)=>{void 0!==e&&s(e);let i=new Map;null==r||r.forEach((e=>{let t=n.getAssetInfo(e._uuid).path.split("/").pop();void 0!==t&&i.set(t,e)})),t(i)}))})).catch(s)}))}},exports.ResourceManager=g=n([l],exports.ResourceManager),(f=exports.UIType||(exports.UIType={})).Standalone="Standalone",f.Normal="Normal",f.Popup="Popup";let I=class{constructor(){this.config={},this.uis=new Map}Load(t){return new Promise(((s,n)=>{if(c(t))return this.build(t),void s(this.config);e.resources.load("configs/uis",e.JsonAsset,((e,t)=>{void 0===e?(this.build(t),s(this.config)):n(e)}))}))}build(e){let t=e.json;this.config=t,Object.keys(this.config).reduce(((e,t)=>e.concat(this.config[t])),new Array).reduce(((e,t)=>e.set(t.name,t)),this.uis)}GetSceneUIs(e){return this.getPersistUIs().concat(this.customSceneUIs(e))}ConvertUIKeys2UINodeInfo(e){return e.map((e=>this.uis.get(e))).filter((e=>c(e)))}getPersistUIs(){return void 0===this.config.Persistence?[]:this.config.Persistence}customSceneUIs(e){return void 0===this.config[e]?[]:this.config[e]}};var S;I=n([l],I);const{ccclass:U,property:y,executionOrder:m}=e._decorator;exports.UIManager=S=class extends e.Component{constructor(){super(),this.config=new I,this.allSpawnedUICaches=new Map,this.standaloneUIs=new Map,this.normalUIs=new Map,this.popupUIs=new Array,Reflect.set(S,"Instance",this)}onLoad(){o.Warn(S.Instance)}initialize(t){return new Promise(((s,n)=>{this.StandaloneUIRoot=e.find("StandaloneUI",this.node),this.NormalUIRoot=e.find("NormalUI",this.node),this.PopupUIRoot=e.find("PopupUI",this.node),this.config.Load(t).then((e=>{s(void 0)}))}))}Get(e,t){return"string"==typeof e?this.getUI(e,(e=>{c(t)&&t(e)})):h.IsUIScriptRegistered(e)?this.getUI(h.GetUIClassRegisteredName(e),(e=>{c(t)&&t(e)})):null}Show(e,t){return"string"==typeof e?this.showUI(e,(e=>{c(t)&&t(e)})):h.IsUIScriptRegistered(e)?this.showUI(h.GetUIClassRegisteredName(e),(e=>{c(t)&&t(e)})):null}Hide(e,t){return"string"==typeof e?this.hideUI(e,(e=>{c(t)&&t(e)})):h.IsUIScriptRegistered(e)?this.hideUI(h.GetUIClassRegisteredName(e),(e=>{c(t)&&t(e)})):void 0}hideUI(e,t){let s=this.getUI(e);if(!c(s))return o.Warn("hide ui %s failed, ui not exists.",e),s;switch(s.UIType){case exports.UIType.Standalone:this.hideStandaloneUI(e);break;case exports.UIType.Normal:this.hideNormalUI(e);break;case exports.UIType.Popup:this.hidePopupUI(e)}return t(s),s}showUI(e,t){let s=this.getUI(e);if(console.log(s),!c(s))return o.Warn("show ui %s failed, ui not exists.",e),s;console.log(s);let n=s.UIType;switch(console.log(n),n){case exports.UIType.Standalone:this.showStandaloneUI(e);break;case exports.UIType.Normal:this.showNormalUI(e);break;case exports.UIType.Popup:this.showPopupUI(e)}return t(s),s}getUI(e,t){if(!this.allSpawnedUICaches.has(e))return null;let s=this.allSpawnedUICaches.get(e);return c(t)&&t(s),s}showStandaloneUI(e){let t=this.getUI(e);[...this.standaloneUIs.values()].filter((t=>t.UIKey!=e)).forEach((e=>{r(e,"handleHide")})),t.Actived||r(t,"handleShow"),this.standaloneUIs.has(e)&&this.standaloneUIs.set(e,t)}hideStandaloneUI(e){if(!this.standaloneUIs.has(e))return;let t=this.standaloneUIs.get(e);t.Actived&&(r(t,"handleHide"),this.standaloneUIs.delete(e));let s=Array.from(this.standaloneUIs.keys()).pop();c(s)&&r(this.standaloneUIs.get(s),"handleShow")}showNormalUI(e){if(this.normalUIs.has(e))return;let t=this.getUI(e);r(t,"handleShow"),this.normalUIs.set(e,t)}hideNormalUI(e){if(!this.normalUIs.has(e))return;r(this.normalUIs.get(e),"handleHide"),this.normalUIs.delete(e)}showPopupUI(e){let t=this.getUI(e);this.popupUIs.includes(t)?(this.popupUIs.splice(this.popupUIs.indexOf(t),1),this.popupUIs.push(t)):this.popupUIs.push(t),t.Actived||r(t,"handleShow");let s=t.node.parent?t.node.parent.children.length-1:0;t.node.setSiblingIndex(s)}hidePopupUI(e){if(this.popupUIs.length<=0)return;let t;if(c(e)){let s=this.allSpawnedUICaches.get(e);if(!c(s))return;if(!this.popupUIs.includes(s))return;t=s,this.popupUIs.splice(this.popupUIs.indexOf(t),1)}else t=this.popupUIs.pop();c(t)||r(t,"handleHide")}start(){}destroyUIs(e){Array.from(this.allSpawnedUICaches.keys()).filter((t=>e.includes(t))).map((e=>this.allSpawnedUICaches.get(e))).forEach((e=>{this.Hide(e.UIKey),e.destroy(),this.allSpawnedUICaches.delete(e.UIKey)})),Array.from(this.standaloneUIs.keys()).filter((t=>e.includes(t))).forEach((e=>{this.standaloneUIs.delete(e)})),Array.from(this.normalUIs.keys()).filter((t=>e.includes(t))).forEach((e=>{this.normalUIs.delete(e)})),this.popupUIs.filter((t=>e.includes(t.UIKey))).forEach((e=>{this.popupUIs.splice(this.popupUIs.indexOf(e),1)}))}onEnterScene(e){this.sceneName=e;let t=this.config.GetSceneUIs(e).map((e=>e.name)),s=Array.from(this.allSpawnedUICaches.keys()),n=s.filter((e=>!t.includes(e)));this.destroyUIs(n);let r=t.filter((e=>!s.includes(e)));console.warn(t,s,r),this.spawnUIs(this.config.ConvertUIKeys2UINodeInfo(r))}spawnUIs(e){e.forEach((e=>{this.spawnUI(e)}))}spawnUI(t){var s,n,i;let o=t.name,a=null!==(s=t.script)&&void 0!==s?s:o,l=null!==(n=t.asset)&&void 0!==n?n:o,u=null!==(i=t.type)&&void 0!==i?i:exports.UIType.Normal;h.IsUIScriptRegistered(a)||console.warn("No ui script registered for ui %s",a);let p=exports.ResourceManager.Instance.Get(l,this.sceneName);if(this.allSpawnedUICaches.has(o))return;if(!c(p))return void console.log("can not find asset %s",l);p=p;const d=e.instantiate(p);d.parent=this.getParentNode(u);let g=d.addComponent(h.GetUIScriptConstructor(a));r(g,"spawned"),Reflect.set(g,"__uiKey",o),Reflect.set(g,"__uiType",u),g.node.active=!1,this.allSpawnedUICaches.set(o,g)}getParentNode(e){return"Normal"===e?this.NormalUIRoot:"Standalone"===e?this.StandaloneUIRoot:"Popup"===e?this.PopupUIRoot:null}},exports.UIManager=S=n([U,m(-1001)],exports.UIManager),console.log("require ui manager");let w=class{constructor(){this.sceneName="",this.scripts=new Map,this.SceneName="SceneEntry"}set SceneName(e){this.sceneName=e;let t=`${this.sceneName}Script`;if(!h.IsSceneScriptRegistered(t))return;let s=h.GetSceneScriptConstrutor(t);this.scripts.set(this.sceneName,new s)}InvokeStartDelegate(){this.invoke("start")}invoke(e,...t){if(!this.scripts.get(this.sceneName))return;let s=this.scripts.get(this.sceneName),n=Reflect.get(s,e);void 0!==n&&Reflect.apply(n,s,[])}};var v;w=n([l],w),exports.SceneManager=v=class{constructor(){this.resConfig=new d,this.scriptManager=new w,this.sceneName="SceneEntry",Reflect.set(v,"Instance",this)}get SceneName(){return this.sceneName}setSceneName(e){this.sceneName=e,this.scriptManager.SceneName=e,Reflect.set(exports.ResourceManager.Instance,"sceneName",this.sceneName)}initialize(){this.setSceneName("SceneEntry"),this.Load("SceneEntry")}Load(e,t,s){o.Log("开始加载场景 %s",e),exports.ResourceManager.Instance.loadScene(e,((e,s,n)=>{c(t)&&t(e/s)}),((n,i)=>{o.Log("场景加载完成..",exports.UIManager.Instance),exports.ResourceManager.Instance.LoadSceneRes([e]).then((()=>{r(exports.UIManager.Instance,"onEnterScene",e),this.setSceneName(e),this.scriptManager.InvokeStartDelegate(),this.onSceneLoaded(e),c(t)&&t(1),c(s)&&s()}))}))}onSceneLoaded(e){}},exports.SceneManager=v=n([l],exports.SceneManager);class N{}N.UI=exports.UIManager.Instance,N.Resource=new exports.ResourceManager,N.Scene=new exports.SceneManager;const{ccclass:x,property:b,executionOrder:C}=e._decorator;exports.CCHelperEntry=class extends u{constructor(){super(...arguments),this.resConfig=null,this.uiConfig=null,this.initializeFunction="initialize"}onLoad(){e.game.addPersistRootNode(this.node),this.initialize()}initialize(){var e;let t=null===(e=this.Get("UIRoot"))||void 0===e?void 0:e.addComponent(exports.UIManager);Reflect.set(N,"UI",t),r(N.Resource,this.initializeFunction,this.resConfig).then((()=>{r(t,this.initializeFunction,this.uiConfig).then((()=>{r(N.Scene,this.initializeFunction)}))}))}start(){}},n([b({type:e.JsonAsset,tooltip:"资源配置文件, 默认加载 resources/configs/res.json"})],exports.CCHelperEntry.prototype,"resConfig",void 0),n([b({type:e.JsonAsset,tooltip:"UI配置文件, 默认加载 resources/configs/uis.json"})],exports.CCHelperEntry.prototype,"uiConfig",void 0),exports.CCHelperEntry=n([x("CCHelperEntry"),C(-1e3)],exports.CCHelperEntry);exports.BaseComponent=u,exports.ISceneScript=class{},exports.Managements=N,exports.MetaData=h,exports.PersistSceneName="Persistence",exports.Platform=class{static get IsBrowser(){var t;return null!==(t=e.sys.isBrowser)&&void 0!==t&&t}},exports.StartSceneName="SceneEntry",exports.UIBase=class extends u{constructor(){super(...arguments),this.__uiType=exports.UIType.Normal,this.isShowing=!1}get UIKey(){return this.__uiKey}get UIType(){return this.__uiType}get Actived(){return this.isShowing}spawned(){}onShow(){}onHide(){}handleShow(){this.isShowing=!0,this.showAction(),this.onShow()}handleHide(){this.isShowing=!1,this.hideAction(),this.onHide()}showAction(){this.node.active=!0}hideAction(){this.node.active=!1}},exports.mapString2CCAssetType=p,exports.scene_script=e=>t=>{r(Reflect.get(h,"sceneScriptClasses"),"set",e,t)},exports.ui_script=e=>t=>{r(Reflect.get(h,"uiClassNamesMap"),"set",t.prototype.constructor.name,e),r(Reflect.get(h,"uiScriptClasses"),"set",e,t)};
